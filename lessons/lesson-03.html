<div class="step" data-step="3" id="step-3">
            <div class="step-number">03</div>
            <div class="step-card">
                <div class="step-header">
                    <div class="step-title">Agent Loop ‚Äî –∑–∞–º—ã–∫–∞–µ–º –ø–µ—Ç–ª—é</div>
                    <span class="step-badge beginner">–ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç</span>
                </div>
                <p class="step-intro">
                    –í–æ—Ç —ç—Ç–æ –∏ –¥–µ–ª–∞–µ—Ç –∞–≥–µ–Ω—Ç–∞ –∞–≥–µ–Ω—Ç–æ–º. –ú–æ–¥–µ–ª—å –≤—ã–∑—ã–≤–∞–µ—Ç <span class="term"
                        data-tip="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/—Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –≤—ã–∑—ã–≤–∞–µ—Ç –º–æ–¥–µ–ª—å">tool</span> ‚Üí –º—ã –≤—ã–ø–æ–ª–Ω—è–µ–º ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    –æ–±—Ä–∞—Ç–Ω–æ –≤ <span class="term" data-tip="–ë–æ–ª—å—à–∞—è —è–∑—ã–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å">LLM</span> ‚Üí repeat.
                </p>

                <div class="step-content">
                    <div class="step-detail">
                        <p>–í—Å—ë —á—Ç–æ –æ–ø–∏—Å–∞–Ω–æ –≤—ã—à–µ —É–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤ ~80 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞. –í–µ—Å—å –∞–≥–µ–Ω—Ç ‚Äî —ç—Ç–æ <code>while</code> loop
                            + –º–∞—Å—Å–∏–≤ <code>messages</code>.
                            –¶–∏–∫–ª –∫—Ä—É—Ç–∏—Ç—Å—è, –ø–æ–∫–∞ –º–æ–¥–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç <code>tool_calls</code>. –ö–æ–≥–¥–∞ –æ–Ω–∞ —Ä–µ—à–∞–µ—Ç, —á—Ç–æ –∑–∞–¥–∞—á–∞
                            –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç, –∏ —Ü–∏–∫–ª –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è.</p>
                    </div>

                    <div class="code-block">
                        <div class="code-filename"><span class="dot"></span>src/03-agent-loop.ts</div>
                        <pre>// src/03-agent-loop.ts
import OpenAI from "openai";
import dotenv from "dotenv";

dotenv.config();

const client = new OpenAI({
    baseURL: "https://openrouter.ai/api/v1",
    apiKey: process.env.OPENROUTER_API_KEY ?? "",
});

const tools: OpenAI.ChatCompletionTool[] = [
    {
        type: "function",
        function: {
            name: "get_weather",
            description: "–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É –≤ –≥–æ—Ä–æ–¥–µ",
            parameters: {
                type: "object",
                properties: {
                    city: { type: "string", description: "–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞" },
                },
                required: ["city"],
            },
        },
    },
    {
        type: "function",
        function: {
            name: "get_time",
            description: "–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –≥–æ—Ä–æ–¥–µ",
            parameters: {
                type: "object",
                properties: {
                    city: { type: "string", description: "–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞" },
                },
                required: ["city"],
            },
        },
    },
];

// –†–µ–µ—Å—Ç—Ä —Ñ—É–Ω–∫—Ü–∏–π ‚Äî –º–∞–ø–ø–∏–Ω–≥ –∏–º—è ‚Üí —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
const toolHandlers: Record&lt;string, (args: any) =&gt; string&gt; = {
    get_weather: ({ city }) =&gt; {
        const data: Record&lt;string, string&gt; = {
            "–ú–æ—Å–∫–≤–∞": "‚àí5¬∞C, —Å–Ω–µ–≥",
            "–ê–Ω–∞–ø–∞": "+8¬∞C, –æ–±–ª–∞—á–Ω–æ",
        };
        return data[city] ?? `–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è ${city}`;
    },
    get_time: ({ city }) =&gt; {
        const now = new Date();
        return `–°–µ–π—á–∞—Å –≤ ${city}: ${now.toLocaleTimeString("ru-RU")}`;
    },
};

async function agentLoop(userMessage: string) {
    // –ù–∞—á–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
    const messages: OpenAI.ChatCompletionMessageParam[] = [
        { role: "system", content: "–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ò—Å–ø–æ–ª—å–∑—É–π tools –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ." },
        { role: "user", content: userMessage },
    ];

    let iteration = 0;
    const MAX_ITERATIONS = 10; // –∑–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞

    while (iteration &lt; MAX_ITERATIONS) {
        iteration++;
        console.log(`\n--- –ò—Ç–µ—Ä–∞—Ü–∏—è ${iteration} ---`);

        const response = await client.chat.completions.create({
            model: "anthropic/claude-sonnet-4.5",
            messages,
            tools,
        });

        const message = response.choices[0].message;

        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
        messages.push(message);

        // –ï—Å–ª–∏ –Ω–µ—Ç tool_calls ‚Äî –º–æ–¥–µ–ª—å —Ä–µ—à–∏–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
        if (!message.tool_calls || message.tool_calls.length === 0) {
            console.log("–ê–≥–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É.");
            console.log("–û—Ç–≤–µ—Ç:", message.content);
            return message.content;
        }

        // –í—ã–ø–æ–ª–Ω—è–µ–º –∫–∞–∂–¥—ã–π tool call
        for (const toolCall of message.tool_calls) {
            const name = toolCall.function.name;
            const args = JSON.parse(toolCall.function.arguments);

            console.log(`Tool: ${name}(${JSON.stringify(args)})`);

            const handler = toolHandlers[name];
            const result = handler
                ? handler(args)
                : `–û—à–∏–±–∫–∞: tool "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω`;

            console.log(`–†–µ–∑—É–ª—å—Ç–∞—Ç: ${result}`);

            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
            messages.push({
                role: "tool",
                tool_call_id: toolCall.id,
                content: result,
            });
        }
        // –¶–∏–∫–ª –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ LLM
    }

    console.log("–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∏—Ç–µ—Ä–∞—Ü–∏–π!");
}

// –¢–µ—Å—Ç–∏—Ä—É–µ–º ‚Äî –∑–∞–ø—Ä–æ—Å, —Ç—Ä–µ–±—É—é—â–∏–π –î–í–ê tool call
agentLoop("–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ –≤ –ú–æ—Å–∫–≤–µ –∏ –ê–Ω–∞–ø–µ? –ò —Å–∫–æ–ª—å–∫–æ —Å–µ–π—á–∞—Å –≤—Ä–µ–º–µ–Ω–∏?");
</pre>
                        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    </div>

                    <div class="run-command">
                        <span class="run-icon">‚ñ∂</span>
                        <code>npx tsx src/03-agent-loop.ts</code>
                    </div>

                    <button class="demo-btn" data-demo="demo-step-3">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–º–æ</button>

                    <div class="demo-output demo-player" id="demo-step-3" data-demo-chat="step3" aria-live="polite">
                        <div class="demo-player-header">
                            <div class="demo-player-title">–î–µ–º–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–∏–∞–ª–æ–≥–∞</div>
                            <div class="demo-player-count"><span data-demo-index>1</span>/<span data-demo-total>1</span>
                            </div>
                        </div>
                        <div class="demo-chat-body" data-demo-chat-body></div>
                        <div class="demo-player-controls">
                            <button class="demo-step-btn" data-demo-prev>‚Üê –ù–∞–∑–∞–¥</button>
                            <div class="demo-step-label" data-demo-label></div>
                            <button class="demo-step-btn" data-demo-next>–î–∞–ª–µ–µ ‚Üí</button>
                        </div>
                    </div>
                    <div class="output-note" data-demo-note="demo-step-3">–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞. –£ —Ç–µ–±—è –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–Ω–∞—á–µ ‚Äî —ç—Ç–æ
                        –Ω–æ—Ä–º–∞–ª—å–Ω–æ.</div>

                    <div class="mini-block expect">
                        <div class="mini-title">‚úÖ –ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å—Å—è</div>
                        –ù–∞ –ø–µ—Ä–≤–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ –µ—Å—Ç—å <code>tool_calls</code>, –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑
                        tool‚Äë–≤—ã–∑–æ–≤–æ–≤.
                    </div>

                    <div class="mini-block trouble">
                        <div class="mini-title">üßØ –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç</div>
                        –ü—Ä–æ–≤–µ—Ä—å –ø–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ (<code>JSON.parse</code>) –∏ —á—Ç–æ handlers –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Å—Ç—Ä–æ–∫—É.
                    </div>

                    <div class="what-happens">
                        <strong>üîç –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ:</strong>
                        <strong>–ò—Ç–µ—Ä–∞—Ü–∏—è 1</strong> ‚Äî –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ —Å—Ä–∞–∑—É 3 tool_calls (–ø–æ–Ω—è–ª–∞, —á—Ç–æ –Ω—É–∂–Ω—ã –≤—Å–µ —Ç—Ä–∏). –ú—ã
                        –≤—ã–ø–æ–ª–Ω–∏–ª–∏, –¥–æ–±–∞–≤–∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç.
                        <strong>–ò—Ç–µ—Ä–∞—Ü–∏—è 2</strong> ‚Äî –º–æ–¥–µ–ª—å –ø–æ–ª—É—á–∏–ª–∞ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, —Ä–µ—à–∏–ª–∞ —á—Ç–æ —Ö–≤–∞—Ç–∏—Ç, –∏ –æ—Ç–≤–µ—Ç–∏–ª–∞ —Ç–µ–∫—Å—Ç–æ–º.
                        –¶–∏–∫–ª –∑–∞–≤–µ—Ä—à–∏–ª—Å—è.
                    </div>

                    <div class="key-insight">
                        <strong>üí° –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:</strong>
                        <code>while</code> loop ‚Äî –∫—Ä—É—Ç–∏–º—Å—è –ø–æ–∫–∞ –º–æ–¥–µ–ª—å –Ω–µ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å <code>tool_calls</code>.
                        <code>messages</code> –º–∞—Å—Å–∏–≤ —Ä–∞—Å—Ç—ë—Ç ‚Äî –∫–∞–∂–¥—ã–π tool result –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è, –º–æ–¥–µ–ª—å –≤–∏–¥–∏—Ç –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é.
                        –ú–æ–¥–µ–ª—å <em>—Å–∞–º–∞ —Ä–µ—à–∞–µ—Ç</em> –∫–æ–≥–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è.
                        <code>MAX_ITERATIONS</code> ‚Äî –∑–∞—â–∏—Ç–∞, —á—Ç–æ–±—ã –∞–≥–µ–Ω—Ç –Ω–µ —É—à—ë–ª –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å.
                    </div>
                </div>
            </div>
        </div>

<!-- –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∞ -->
<script type="application/json" data-demo-steps="step3">
[
    {
        "label": "–ò—Ç–µ—Ä–∞—Ü–∏—è 1",
        "messages": [
            {
                "role": "user",
                "text": "–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ –≤ –ú–æ—Å–∫–≤–µ –∏ –ê–Ω–∞–ø–µ? –ò —Å–∫–æ–ª—å–∫–æ —Å–µ–π—á–∞—Å –≤—Ä–µ–º–µ–Ω–∏?"
            },
            {
                "role": "tool_call",
                "text": "get_weather({\"city\":\"–ú–æ—Å–∫–≤–∞\"})"
            },
            {
                "role": "tool_result",
                "text": "‚àí5¬∞C, —Å–Ω–µ–≥"
            },
            {
                "role": "tool_call",
                "text": "get_weather({\"city\":\"–ê–Ω–∞–ø–∞\"})"
            },
            {
                "role": "tool_result",
                "text": "+8¬∞C, –æ–±–ª–∞—á–Ω–æ"
            },
            {
                "role": "tool_call",
                "text": "get_time({\"city\":\"–ú–æ—Å–∫–≤–∞\"})"
            },
            {
                "role": "tool_result",
                "text": "–°–µ–π—á–∞—Å –≤ –ú–æ—Å–∫–≤–∞: 20:04:51"
            }
        ]
    },
    {
        "label": "–ò—Ç–µ—Ä–∞—Ü–∏—è 2",
        "messages": [
            {
                "role": "llm",
                "text": "–í–æ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n\n**–ü–æ–≥–æ–¥–∞:**\n- **–ú–æ—Å–∫–≤–∞:** ‚àí5¬∞C, —Å–Ω–µ–≥ ‚ùÑÔ∏è\n- **–ê–Ω–∞–ø–∞:** +8¬∞C, –æ–±–ª–∞—á–Ω–æ ‚òÅÔ∏è\n\n**–í—Ä–µ–º—è:**\n- –°–µ–π—á–∞—Å –≤ –ú–æ—Å–∫–≤–µ: 20:04:51"
            }
        ]
    }
]
</script>
