<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£—Ä–æ–∫ 06 ¬∑ Multi-step Planning</title>
    <meta name="description" content="–†–∞–∑–¥–µ–ª—è–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ –¥–≤–µ —Ñ–∞–∑—ã: —Å–Ω–∞—á–∞–ª–∞ –º–æ–¥–µ–ª—å —Å—Ç—Ä–æ–∏—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω, –∑–∞—Ç–µ–º –∏—Å–ø–æ–ª–Ω—è–µ—Ç –µ–≥–æ —á–µ—Ä–µ–∑ tools.">
    <meta name="color-scheme" content="dark">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/base16/ocean.min.css" />
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <header class="site-header">
        <div class="container header-inner">
            <a class="brand" href="index.html">AI Agents Book</a>
            <nav class="header-nav">
                <a href="index.html">–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ</a>
                <a href="lesson-01-basic-call.html">–ù–∞—á–∞—Ç—å –∫—É—Ä—Å</a>
            </nav>
        </div>
    </header>

    <main class="site-main">
        <div class="container">
            <div class="lesson-layout">
    <aside class="panel lesson-sidebar">
        <h2>–í—Å–µ —É—Ä–æ–∫–∏</h2>
        <nav class="toc-nav">
            <a class="toc-link" href="lesson-01-basic-call.html">01. –ë–∞–∑–æ–≤—ã–π LLM-–≤—ã–∑–æ–≤</a>
<a class="toc-link" href="lesson-02-with-tool.html">02. –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π Tool</a>
<a class="toc-link" href="lesson-03-agent-loop.html">03. Agent Loop: –∑–∞–º—ã–∫–∞–µ–º –ø–µ—Ç–ª—é</a>
<a class="toc-link" href="lesson-04-real-tools.html">04. –†–µ–∞–ª—å–Ω—ã–µ Tools: bash –∏ —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞</a>
<a class="toc-link" href="lesson-05-skills.html">05. Skills: –º–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</a>
<a class="toc-link current" href="lesson-06-planning.html">06. Multi-step Planning</a>
<a class="toc-link" href="lesson-07-adaptive-agent.html">07. Adaptive Agent: Plan + ReAct + Replan</a>
<a class="toc-link" href="lesson-08-interactive-agent.html">08. Human-in-the-Loop + Wizard</a>
        </nav>
    </aside>

    <article class="panel lesson-panel">
        <p class="eyebrow">–£—Ä–æ–∫ 06</p>
        <h1>Multi-step Planning</h1>
        <div class="lesson-meta">
            <span class="chip">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π</span>
            <span class="chip">35-45 –º–∏–Ω—É—Ç</span>
            <span class="chip">–§–∞–π–ª: <code>src/06-planning.ts</code></span>
        </div>

        <p class="lead">–†–∞–∑–¥–µ–ª—è–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ –¥–≤–µ —Ñ–∞–∑—ã: —Å–Ω–∞—á–∞–ª–∞ –º–æ–¥–µ–ª—å —Å—Ç—Ä–æ–∏—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω, –∑–∞—Ç–µ–º –∏—Å–ø–æ–ª–Ω—è–µ—Ç –µ–≥–æ —á–µ—Ä–µ–∑ tools.</p>

        <section class="lesson-section">
            <h2>–ß—Ç–æ —Å–¥–µ–ª–∞–µ–º –≤ —É—Ä–æ–∫–µ</h2>
            <ul class="text-list">
                <li>–°–¥–µ–ª–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ–∞–∑—É –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å JSON-–æ—Ç–≤–µ—Ç–æ–º.</li>
<li>–ü—Ä–æ–≤–µ—Å—Ç–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é/–ø–∞—Ä—Å–∏–Ω–≥ –ø–ª–∞–Ω–∞ –¥–æ —Å—Ç–∞—Ä—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.</li>
<li>–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–∞–∑—É –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —Å –æ—Ç—á–µ—Ç–æ–º –ø–æ —à–∞–≥–∞–º.</li>
            </ul>
        </section>

        <section class="lesson-section">
            <h2>–ö–ª—é—á–µ–≤—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã</h2>
            <ul class="text-list">
                <li>Plan-first —Å–Ω–∏–∂–∞–µ—Ç —Ö–∞–æ—Ç–∏—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∞–≥–µ–Ω—Ç–∞.</li>
<li>–Ø–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–ª–∞–Ω–∞ –ø–æ–º–æ–≥–∞–µ—Ç –¥–µ–±–∞–∂–∏—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏.</li>
<li>–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π (planner/executor) –ø–æ–≤—ã—à–∞–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å.</li>
            </ul>
        </section>

        <section class="lesson-section">
            <h2>–ö–æ–¥ —É—Ä–æ–∫–∞</h2>
            <pre><code class="language-typescript">// src/06-planning.ts
// –ê–≥–µ–Ω—Ç —Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º: —Å–Ω–∞—á–∞–ª–∞ –¥—É–º–∞–µ—Ç, –ø–æ—Ç–æ–º –¥–µ–ª–∞–µ—Ç
import OpenAI from &quot;openai&quot;;
import { execSync } from &quot;child_process&quot;;
import { readFileSync, writeFileSync } from &quot;fs&quot;;
import dotenv from &quot;dotenv&quot;;

dotenv.config();

const client = new OpenAI({
    baseURL: &quot;https://openrouter.ai/api/v1&quot;,
    apiKey: process.env.OPENROUTER_API_KEY ?? &quot;&quot;,
});

const MODEL = &quot;anthropic/claude-sonnet-4.5&quot;;

// ============================================================
// TOOLS (—Ç–µ –∂–µ —á—Ç–æ –≤ 05, –Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º think tool)
// ============================================================

const tools: OpenAI.ChatCompletionTool[] = [
    {
        type: &quot;function&quot;,
        function: {
            name: &quot;think&quot;,
            description:
                &quot;–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —á—Ç–æ–±—ã –ø–æ–¥—É–º–∞—Ç—å, —Å–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –ø–æ—Ä–∞—Å—Å—É–∂–¥–∞—Ç—å. &quot; +
                &quot;–†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –≤–∏–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ‚Äî —ç—Ç–æ —Ç–≤–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±–ª–æ–∫–Ω–æ—Ç.&quot;,
            parameters: {
                type: &quot;object&quot;,
                properties: {
                    thought: {
                        type: &quot;string&quot;,
                        description: &quot;–¢–≤–æ–∏ –º—ã—Å–ª–∏, –ø–ª–∞–Ω, —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è&quot;,
                    },
                },
                required: [&quot;thought&quot;],
            },
        },
    },
    {
        type: &quot;function&quot;,
        function: {
            name: &quot;run_bash&quot;,
            description: &quot;–í—ã–ø–æ–ª–Ω–∏—Ç—å bash-–∫–æ–º–∞–Ω–¥—É&quot;,
            parameters: {
                type: &quot;object&quot;,
                properties: {
                    command: { type: &quot;string&quot;, description: &quot;–ö–æ–º–∞–Ω–¥–∞&quot; },
                },
                required: [&quot;command&quot;],
            },
        },
    },
    {
        type: &quot;function&quot;,
        function: {
            name: &quot;read_file&quot;,
            description: &quot;–ü—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª&quot;,
            parameters: {
                type: &quot;object&quot;,
                properties: {
                    path: { type: &quot;string&quot;, description: &quot;–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É&quot; },
                },
                required: [&quot;path&quot;],
            },
        },
    },
    {
        type: &quot;function&quot;,
        function: {
            name: &quot;write_file&quot;,
            description: &quot;–ó–∞–ø–∏—Å–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ —Ñ–∞–π–ª&quot;,
            parameters: {
                type: &quot;object&quot;,
                properties: {
                    path: { type: &quot;string&quot;, description: &quot;–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É&quot; },
                    content: { type: &quot;string&quot;, description: &quot;–°–æ–¥–µ—Ä–∂–∏–º–æ–µ&quot; },
                },
                required: [&quot;path&quot;, &quot;content&quot;],
            },
        },
    },
];

const toolHandlers: Record&lt;string, (args: any) =&gt; string&gt; = {
    think: ({ thought }) =&gt; {
        // Think tool –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.
        // –í—Å—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ç–æ–º, —á—Ç–æ –º–æ–¥–µ–ª—å &quot;–ø—Ä–æ–≥–æ–≤–æ—Ä–∏–ª–∞&quot; –º—ã—Å–ª—å.
        return &quot;OK&quot;;
    },
    run_bash: ({ command }) =&gt; {
        try {
            return execSync(command, { encoding: &quot;utf-8&quot;, timeout: 10000 }).trim();
        } catch (e: any) {
            return `–û—à–∏–±–∫–∞: ${e.stderr || e.message}`;
        }
    },
    read_file: ({ path }) =&gt; {
        try {
            return readFileSync(path, &quot;utf-8&quot;);
        } catch (e: any) {
            return `–û—à–∏–±–∫–∞: ${e.message}`;
        }
    },
    write_file: ({ path, content }) =&gt; {
        try {
            writeFileSync(path, content, &quot;utf-8&quot;);
            return `‚úÖ –§–∞–π–ª ${path} –∑–∞–ø–∏—Å–∞–Ω (${content.length} –±–∞–π—Ç)`;
        } catch (e: any) {
            return `–û—à–∏–±–∫–∞: ${e.message}`;
        }
    },
};

// ============================================================
// –ü–û–î–•–û–î 1: Plan-then-Execute
// –î–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —ç—Ç–∞–ø–∞: —Å–Ω–∞—á–∞–ª–∞ –ø–ª–∞–Ω, –ø–æ—Ç–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
// ============================================================

async function planThenExecute(userMessage: string) {
    console.log(&quot;‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó&quot;);
    console.log(&quot;‚ïë   –ü–û–î–•–û–î 1: Plan-then-Execute            ‚ïë&quot;);
    console.log(&quot;‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n&quot;);

    // --- –§–ê–ó–ê 1: –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–±–µ–∑ tools!) ---
    console.log(&quot;üìã –§–ê–ó–ê 1: –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ï\n&quot;);

    const planResponse = await client.chat.completions.create({
        model: MODEL,
        messages: [
            {
                role: &quot;system&quot;,
                content: `–¢—ã –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á. –ü–æ–ª—É—á–∏–≤ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–æ—Å—Ç–∞–≤—å –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω.

–ü—Ä–∞–≤–∏–ª–∞:
- –ö–∞–∂–¥—ã–π —à–∞–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –≤—ã–ø–æ–ª–Ω–∏–º—ã–º
- –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç JSON
- –ù–ï –≤—ã–ø–æ–ª–Ω—è–π –∑–∞–¥–∞—á—É, —Ç–æ–ª—å–∫–æ —Å–ø–ª–∞–Ω–∏—Ä—É–π

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
- run_bash: –≤—ã–ø–æ–ª–Ω–∏—Ç—å bash-–∫–æ–º–∞–Ω–¥—É
- read_file: –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª
- write_file: –∑–∞–ø–∏—Å–∞—Ç—å —Ñ–∞–π–ª

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
{
  &quot;goal&quot;: &quot;–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ü–µ–ª–∏&quot;,
  &quot;steps&quot;: [
    { &quot;id&quot;: 1, &quot;action&quot;: &quot;–æ–ø–∏—Å–∞–Ω–∏–µ —à–∞–≥–∞&quot;, &quot;tool&quot;: &quot;–∏–º—è_tool&quot;, &quot;reason&quot;: &quot;–∑–∞—á–µ–º&quot; },
    ...
  ]
}`,
            },
            { role: &quot;user&quot;, content: userMessage },
        ],
    });

    const planText = planResponse.choices[0].message.content ?? &quot;&quot;;

    // –ü–∞—Ä—Å–∏–º –ø–ª–∞–Ω
    let plan: { goal: string; steps: { id: number; action: string; tool: string; reason: string }[] };
    try {
        // –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ markdown-–æ–±—ë—Ä—Ç–∫–∏
        const cleanJson = planText.replace(/```json\n?/g, &quot;&quot;).replace(/```\n?/g, &quot;&quot;).trim();
        plan = JSON.parse(cleanJson);
    } catch (e) {
        console.log(&quot;‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –ø–ª–∞–Ω:&quot;);
        console.log(planText);
        return;
    }

    console.log(`üéØ –¶–µ–ª—å: ${plan.goal}`);
    console.log(`üìù –®–∞–≥–æ–≤: ${plan.steps.length}\n`);
    plan.steps.forEach((s) =&gt; {
        console.log(`   ${s.id}. [${s.tool}] ${s.action}`);
        console.log(`      ‚îî‚îÄ ${s.reason}`);
    });

    // --- –§–ê–ó–ê 2: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (—Å tools) ---
    console.log(&quot;\n\n‚ö° –§–ê–ó–ê 2: –í–´–ü–û–õ–ù–ï–ù–ò–ï\n&quot;);

    const messages: OpenAI.ChatCompletionMessageParam[] = [
        {
            role: &quot;system&quot;,
            content: `–¢—ã –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –∑–∞–¥–∞—á. –í—ã–ø–æ–ª–Ω–∏ –ø–ª–∞–Ω –ø–æ—à–∞–≥–æ–≤–æ, –∏—Å–ø–æ–ª—å–∑—É—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.

–ü–õ–ê–ù:
${JSON.stringify(plan, null, 2)}

–í—ã–ø–æ–ª–Ω—è–π —à–∞–≥–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É. –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ —Å–æ–æ–±—â–∞–π –ø—Ä–æ–≥—Ä–µ—Å—Å.
–ï—Å–ª–∏ —à–∞–≥ –Ω–µ –ø–æ–ª—É—á–∏–ª—Å—è ‚Äî –∞–¥–∞–ø—Ç–∏—Ä—É–π –ø–ª–∞–Ω.
–ö–æ–≥–¥–∞ –≤—Å–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã ‚Äî –ø–æ–¥–≤–µ–¥–∏ –∏—Ç–æ–≥.`,
        },
        { role: &quot;user&quot;, content: userMessage },
    ];

    let iteration = 0;

    while (iteration &lt; 15) {
        iteration++;
        console.log(`\n--- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –∏—Ç–µ—Ä–∞—Ü–∏—è ${iteration} ---`);

        const response = await client.chat.completions.create({
            model: MODEL,
            messages,
            tools,
        });

        const message = response.choices[0].message;
        messages.push(message);

        if (!message.tool_calls?.length) {
            console.log(&quot;\n‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.&quot;);
            console.log(&quot;–ò—Ç–æ–≥:&quot;, message.content);
            return;
        }

        for (const toolCall of message.tool_calls) {
            const name = toolCall.function.name;
            const args = JSON.parse(toolCall.function.arguments);
            const argsPreview =
                name === &quot;write_file&quot;
                    ? `{path: &quot;${args.path}&quot;, content: [${args.content.length} chars]}`
                    : JSON.stringify(args);

            console.log(`   üîß ${name}(${argsPreview})`);

            const result = toolHandlers[name]?.(args) ?? `Tool &quot;${name}&quot; –Ω–µ –Ω–∞–π–¥–µ–Ω`;
            console.log(`   ‚Üí ${result.slice(0, 120)}`);

            messages.push({
                role: &quot;tool&quot;,
                tool_call_id: toolCall.id,
                content: result,
            });
        }
    }
}

// ============================================================
// –ü–û–î–•–û–î 2: ReAct (Reasoning + Acting)
// –î—É–º–∞–µ—Ç –∏ –¥–µ–π—Å—Ç–≤—É–µ—Ç –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ —á–µ—Ä–µ–∑ think tool
// ============================================================

async function reactAgent(userMessage: string) {
    console.log(&quot;‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó&quot;);
    console.log(&quot;‚ïë   –ü–û–î–•–û–î 2: ReAct (Reason + Act)         ‚ïë&quot;);
    console.log(&quot;‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n&quot;);

    const messages: OpenAI.ChatCompletionMessageParam[] = [
        {
            role: &quot;system&quot;,
            content: `–¢—ã –∞–≥–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ—à–∞–µ—Ç –∑–∞–¥–∞—á–∏ –ø–æ—à–∞–≥–æ–≤–æ.

–ú–ï–¢–û–î –†–ê–ë–û–¢–´:
1. –ü–µ—Ä–µ–¥ –ö–ê–ñ–î–´–ú –¥–µ–π—Å—Ç–≤–∏–µ–º —Å–Ω–∞—á–∞–ª–∞ –≤—ã–∑–æ–≤–∏ tool &quot;think&quot; ‚Äî –æ–±–¥—É–º–∞–π:
   - –ß—Ç–æ —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–æ?
   - –ö–∞–∫–æ–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥?
   - –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç —à–∞–≥?
2. –ó–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏ –¥–µ–π—Å—Ç–≤–∏–µ –Ω—É–∂–Ω—ã–º tool
3. –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–Ω–æ–≤–∞ &quot;think&quot; ‚Äî –æ—Ü–µ–Ω–∏:
   - –ü–æ–ª—É—á–∏–ª–æ—Å—å –ª–∏?
   - –ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç?
   - –ö–∞–∫–æ–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥?

–í–ê–ñ–ù–û: –í—Å–µ–≥–¥–∞ —á–µ—Ä–µ–¥—É–π think ‚Üí action ‚Üí think ‚Üí action.
–ù–µ –¥–µ–ª–∞–π –¥–µ–π—Å—Ç–≤–∏–π –±–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–¥—É–º—ã–≤–∞–Ω–∏—è.

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: think, run_bash, read_file, write_file.`,
        },
        { role: &quot;user&quot;, content: userMessage },
    ];

    let iteration = 0;

    while (iteration &lt; 20) {
        iteration++;

        const response = await client.chat.completions.create({
            model: MODEL,
            messages,
            tools,
        });

        const message = response.choices[0].message;
        messages.push(message);

        if (!message.tool_calls?.length) {
            console.log(`\n‚úÖ –ê–≥–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É (${iteration} –∏—Ç–µ—Ä–∞—Ü–∏–π).`);
            console.log(&quot;–û—Ç–≤–µ—Ç:&quot;, message.content);
            return;
        }

        for (const toolCall of message.tool_calls) {
            const name = toolCall.function.name;
            const args = JSON.parse(toolCall.function.arguments);

            if (name === &quot;think&quot;) {
                // –ö—Ä–∞—Å–∏–≤–æ –≤—ã–≤–æ–¥–∏–º –º—ã—Å–ª–∏ –∞–≥–µ–Ω—Ç–∞
                console.log(`\nüí≠ [–ú—ã—Å–ª—å]: ${args.thought}`);
            } else {
                const argsPreview =
                    name === &quot;write_file&quot;
                        ? `{path: &quot;${args.path}&quot;, content: [${args.content.length} chars]}`
                        : JSON.stringify(args);
                console.log(`   üîß ${name}(${argsPreview})`);

                const result = toolHandlers[name]?.(args) ?? `Tool &quot;${name}&quot; –Ω–µ –Ω–∞–π–¥–µ–Ω`;
                console.log(`   ‚Üí ${result.slice(0, 120)}`);

                messages.push({
                    role: &quot;tool&quot;,
                    tool_call_id: toolCall.id,
                    content: result,
                });
                continue;
            }

            // Think –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç OK
            messages.push({
                role: &quot;tool&quot;,
                tool_call_id: toolCall.id,
                content: &quot;OK&quot;,
            });
        }
    }
}

// ============================================================
// MAIN: –≤—ã–±–µ—Ä–∏ –ø–æ–¥—Ö–æ–¥
// ============================================================

async function main() {
    const task =
        &quot;–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤—Å–µ .ts —Ñ–∞–π–ª—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ src/. &quot; +
        &quot;–ù–∞–π–¥–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –º–µ–∂–¥—É —Ñ–∞–π–ª–∞–º–∏ (–æ–±—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, &quot; +
        &quot;–ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∏–º–ø–æ—Ä—Ç—ã, –ø–æ—Ö–æ–∂–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏). &quot; +
        &quot;–°–æ–∑–¥–∞–π —Ñ–∞–π–ª REFACTORING.md —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É.&quot;;

    // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –Ω—É–∂–Ω—ã–π –ø–æ–¥—Ö–æ–¥:
    const approach = process.argv[2] ?? &quot;plan&quot;;

    if (approach === &quot;plan&quot;) {
        await planThenExecute(task);
    } else if (approach === &quot;react&quot;) {
        await reactAgent(task);
    } else {
        console.log(&quot;–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: npx tsx src/06-planning.ts [plan|react]&quot;);
    }
}

main();
</code></pre>
        </section>

        <nav class="lesson-pager">
            <a class="pager-link" href="lesson-05-skills.html">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π —É—Ä–æ–∫</a>
            <a class="pager-link" href="index.html">–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ</a>
            <a class="pager-link" href="lesson-07-adaptive-agent.html">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫ ‚Üí</a>
        </nav>
    </article>
</div>

        </div>
    </main>

    <footer class="site-footer">
        <div class="container footer-inner">
            <p>¬© 2026 –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —É—á–µ–±–Ω–∏–∫ –ø–æ –∞–≥–µ–Ω—Ç–∞–º –Ω–∞ TypeScript.</p>
            <a href="index.html">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–≥–ª–∞–≤–ª–µ–Ω–∏—é</a>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        if (window.hljs) {
            document.querySelectorAll('pre code').forEach((el) => {
                window.hljs.highlightElement(el);
            });
        }
    </script>
</body>
</html>
